<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parking Management System</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      :root {
        --primary-color: #2563eb;
        --secondary-color: #1e40af;
        --success-color: #059669;
        --warning-color: #d97706;
        --danger-color: #dc2626;
        --background-color: #f8fafc;
        --card-background: #ffffff;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border-radius: 12px;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Roboto', sans-serif;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
      }

      .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 1rem;
        width: 100%;
      }

      .header {
        background-color: var(--card-background);
        padding: 1.25rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
        flex: 1;
        min-width: 200px;
      }

      .university-logo {
        width: 60px;
        height: 60px;
        object-fit: contain;
        border-radius: 8px;
        background-color: #f8fafc;
        padding: 4px;
        border: 2px solid #e2e8f0;
        flex-shrink: 0;
      }

      .header-text {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .header h1 {
        color: var(--text-primary);
        font-size: clamp(1.25rem, 4vw, 1.5rem);
        font-weight: 600;
        margin: 0;
        line-height: 1.2;
      }

      .university-name {
        color: var(--primary-color);
        font-size: clamp(0.875rem, 2.5vw, 1rem);
        font-weight: 500;
        margin: 0;
        font-style: italic;
      }

      .header .status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--success-color);
        font-weight: 500;
        font-size: clamp(0.875rem, 2.5vw, 1rem);
      }

      .header .status i {
        font-size: 0.875rem;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .vehicle-card {
        background: var(--card-background);
        padding: 1.25rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .vehicle-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
      }

      .vehicle-card .icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .vehicle-card .icon i {
        font-size: 1.5rem;
        color: white;
      }

      .vehicle-card .icon.cars { background-color: var(--primary-color); }
      .vehicle-card .icon.bikes { background-color: var(--success-color); }

      .card-header h3 {
        font-size: clamp(1rem, 3vw, 1.25rem);
        color: var(--text-primary);
        font-weight: 600;
      }

      .card-body {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        flex-grow: 1;
        justify-content: space-between;
      }

      .info-columns {
        display: flex;
        justify-content: space-around;
        text-align: center;
        gap: 1rem;
      }

      .info-col {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        align-items: center;
      }
      
      .info-label-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        justify-content: center;
      }

      .info-label {
        color: var(--text-secondary);
        font-size: clamp(0.875rem, 2.5vw, 1rem);
        font-weight: 500;
      }

      .info-value {
        font-size: clamp(1.75rem, 5vw, 2.25rem);
        font-weight: 700;
        color: var(--text-primary);
      }

      .card-footer {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        font-size: clamp(0.875rem, 2.5vw, 1rem);
        color: var(--text-secondary);
        padding-top: 0.5rem;
      }
      
      .capacity-label {
        font-weight: 500;
      }

      .capacity-value {
        font-weight: 600;
        color: var(--text-primary);
      }

      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal-content {
        background-color: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 400px;
        text-align: left;
      }

      .modal-content h4 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        font-size: 1.25rem;
        color: var(--text-primary);
        text-align: center;
      }

      .modal-option {
        margin-bottom: 1rem;
      }

      .modal-option label {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-weight: 500;
      }

      .modal-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
        margin-top: 0.5rem;
      }

      .modal-input:disabled {
        background-color: #f1f5f9;
      }

      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 1.5rem;
      }

      .modal-button {
        padding: 0.6rem 1.2rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
      }

      .update-btn {
        background-color: var(--primary-color);
        color: white;
      }

      .update-btn:hover {
        background-color: var(--secondary-color);
      }

      .cancel-btn {
        background-color: #e2e8f0;
        color: var(--text-primary);
      }

      .cancel-btn:hover {
        background-color: #cbd5e1;
      }

      .card-progress {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: clamp(0.875rem, 2.5vw, 1rem);
        font-weight: 500;
        color: var(--text-primary);
      }

      .progress-fill.car-progress {
        background: linear-gradient(90deg, var(--primary-color), #3b82f6);
      }

      .progress-fill.bike-progress {
        background: linear-gradient(90deg, var(--success-color), #10b981);
      }

      .capacity-container {
        background: var(--card-background);
        padding: 1.25rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        margin-bottom: 1.5rem;
      }

      .capacity-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .capacity-header span {
        font-weight: 500;
        color: var(--text-primary);
        font-size: clamp(0.875rem, 2.5vw, 1rem);
      }

      .capacity-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
        gap: 0.5rem;
        font-size: clamp(0.75rem, 2vw, 0.875rem);
        color: var(--text-secondary);
      }

      .progress-bar {
        width: 100%;
        height: 10px;
        background-color: #e2e8f0;
        border-radius: 5px;
        overflow: hidden;
      }

      .edit-icon {
            cursor: pointer;
            color: #90a4ae;
            font-size: 0.9em;
            transition: color 0.2s;
        }

        .edit-icon:hover {
            color: #37474f;
        }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        transition: width 0.3s ease;
        border-radius: 5px;
      }

      .lot-full {
        background-color: #fee2e2;
        border-left: 4px solid var(--danger-color);
        padding: 1rem;
        margin: 1.5rem 0;
        display: none;
        border-radius: var(--border-radius);
        color: var(--danger-color);
        font-weight: 500;
        font-size: clamp(0.875rem, 2.5vw, 1rem);
      }

      .lot-full i {
        margin-right: 0.5rem;
      }

      .video-container {
        background: var(--card-background);
        padding: 1.25rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
      }

      .video-feed {
        width: 100%;
        max-width: 100%;
        height: auto;
        display: block;
        border-radius: var(--border-radius);
        aspect-ratio: 16/9;
        object-fit: cover;
        background-color: #f1f5f9;
      }

      /* Mobile First Responsive Design */
      @media (max-width: 480px) {
        .container {
          padding: 0.75rem;
        }

        .header {
          padding: 1rem;
          text-align: center;
          flex-direction: column;
        }

        .header-left {
          flex-direction: column;
          text-align: center;
          gap: 0.75rem;
        }

        .university-logo {
          width: 50px;
          height: 50px;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .vehicle-card {
          padding: 1.25rem;
        }

        .card-header {
          gap: 0.75rem;
        }

        .vehicle-card .icon {
          width: 40px;
          height: 40px;
        }

        .vehicle-card .icon i {
          font-size: 1.25rem;
        }

        .card-stats {
          gap: 0.5rem;
        }

        .stat-row {
          padding: 0.375rem 0;
        }

        .capacity-container,
        .video-container {
          padding: 1rem;
        }

        .capacity-header {
          text-align: center;
          flex-direction: column;
          gap: 0.25rem;
        }

        .capacity-details {
          justify-content: center;
          text-align: center;
          flex-direction: column;
          gap: 0.25rem;
        }
      }

      @media (min-width: 481px) and (max-width: 768px) {
        .container {
          padding: 0.875rem;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
          gap: 1.25rem;
        }

        .header h1 {
          font-size: 1.375rem;
        }
      }

      @media (min-width: 769px) and (max-width: 1024px) {
        .container {
          padding: 1.25rem;
        }

        .dashboard-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 1.5rem;
        }
      }

      @media (min-width: 1025px) {
        .container {
          padding: 2rem;
        }

        .dashboard-grid {
          gap: 2rem;
        }

        .capacity-container,
        .video-container {
          padding: 1.5rem;
        }
      }

      /* Landscape orientation adjustments */
      @media (orientation: landscape) and (max-height: 500px) {
        .container {
          padding: 0.5rem;
        }

        .header {
          padding: 0.75rem;
        }

        .header-left {
          gap: 0.5rem;
        }

        .university-logo {
          width: 40px;
          height: 40px;
        }

        .vehicle-card {
          min-height: 80px;
          padding: 1rem;
        }

        .video-feed {
          max-height: 250px;
        }
      }

      /* High DPI displays */
      @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
        .vehicle-card .icon i {
          transform: scale(0.95);
        }
      }

      /* Dark mode support */
      @media (prefers-color-scheme: dark) {
        :root {
          --background-color: #0f172a;
          --card-background: #1e293b;
          --text-primary: #f8fafc;
          --text-secondary: #94a3b8;
        }

        .progress-bar {
          background-color: #334155;
        }

        .lot-full {
          background-color: #3c2626;
        }
      }
    </style>
  </head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <img src="static/culogo.png" alt="Christ University Logo" class="university-logo">
                <div class="header-text">
                    <h1>R&D Block Parking<h1>
                    <p class="university-name">Christ (Deemed to be University)</p>
                </div>
            </div>
            <div class="status" id="system-status">
                <i class="fas fa-circle"></i>
                System Active
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="vehicle-card">
                <div class="card-header">
                    <div class="icon cars">
                        <i class="fas fa-car"></i>
                    </div>
                    <h3>Four Wheeler</h3>
                </div>
                <div class="card-body">
                    <div class="info-columns">
                        <div class="info-col">
                            <span class="info-label">Free</span>
                            <span class="info-value" id="car-free">40</span>
                        </div>
                        <div class="info-col">
                            <div class="info-label-container">
                                <span class="info-label">Filled</span>
                                <i class="fas fa-pencil-alt edit-icon" data-type="car"></i>
                            </div>
                            <span class="info-value" id="car-filled">0</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <span class="capacity-label">Capacity:</span>
                        <span class="capacity-value">40</span>
                    </div>
                </div>
                <div class="card-progress">
                    <div class="progress-header">
                        <span>Occupancy</span>
                        <span id="car-percentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill car-progress" id="car-progress-bar"></div>
                    </div>
                </div>
            </div>
            
            <div class="vehicle-card">
                <div class="card-header">
                    <div class="icon bikes">
                        <i class="fas fa-motorcycle"></i>
                    </div>
                    <h3>Two Wheeler</h3>
                </div>
                <div class="card-body">
                    <div class="info-columns">
                        <div class="info-col">
                            <span class="info-label">Free</span>
                            <span class="info-value" id="bike-free">300</span>
                        </div>
                        <div class="info-col">
                            <div class="info-label-container">
                                <span class="info-label">Filled</span>
                                <i class="fas fa-pencil-alt edit-icon" data-type="bike"></i>
                            </div>
                            <span class="info-value" id="bike-filled" color="red">0</span>
                        </div>
                    </div>
                    <div class="card-footer">
                        <span class="capacity-label">Capacity:</span>
                        <span class="capacity-value">300</span>
                    </div>
                </div>
                <div class="card-progress">
                    <div class="progress-header">
                        <span>Occupancy</span>
                        <span id="bike-percentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill bike-progress" id="bike-progress-bar"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="capacity-container">
            <div class="capacity-header">
                <span>Lot Capacity Usage</span>
                <span id="capacity-percentage">0%</span>
            </div>
            <div class="capacity-details">
                <span>Car Spots: <span id="car-capacity">0/40</span></span>
                <span>Bike Spots: <span id="bike-capacity">0/300</span></span>
                <span>Total: <span id="total-capacity">0/340</span></span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="capacity-bar"></div>
            </div>
        </div>

        <div class="lot-full" id="lot-full-alert">
            <i class="fas fa-exclamation-circle"></i>
            Parking lot is full!
        </div>

        <div class="video-container">
            <img
              src="{{ url_for('video_feed') }}"
              class="video-feed"
              alt="Video Feed"
              loading="lazy"
            />
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal-content">
            <h4 id="modal-title">Update Count</h4>
            <div class="modal-option">
                <label>
                    <input type="radio" name="update-type" value="total" checked>
                    Modify Total
                </label>
                <input type="number" id="total-input" class="modal-input">
            </div>
            <div class="modal-option">
                <label>
                    <input type="radio" name="update-type" value="additive">
                    Add/Remove Vehicles
                </label>
                <input type="number" id="additive-input" class="modal-input" value="1" disabled>
            </div>
            <div class="modal-buttons">
                <button class="modal-button cancel-btn" id="cancel-btn">Cancel</button>
                <button class="modal-button update-btn" id="update-btn">Update</button>
            </div>
        </div>
    </div>

<script>
        $(document).ready(function() {
            const CAR_CAPACITY = 40;
            const BIKE_CAPACITY = 300;
            const TOTAL_CAPACITY = CAR_CAPACITY + BIKE_CAPACITY;

            let isManualUpdateActive = false;
            let manualUpdateTimer;

            /**
             * Central function to update all UI elements based on car and bike counts.
             * @param {object} data - An object containing the counts, e.g., { cars: 10, bikes: 50 }.
             */
            function updateUI(data) {
                const cars = data.cars;
                const bikes = data.bikes;
                const filledSpaces = cars + bikes;

                // Update car card
                const carFreeSpots = Math.max(0, CAR_CAPACITY - cars);
                $("#car-filled").text(cars);
                $("#car-free").text(carFreeSpots);
                const carPercentage = (cars / CAR_CAPACITY) * 100;
                $("#car-percentage").text(Math.round(carPercentage) + "%");
                $("#car-progress-bar").css("width", carPercentage + "%");

                // Update bike card
                const bikeFreeSpots = Math.max(0, BIKE_CAPACITY - bikes);
                $("#bike-filled").text(bikes);
                $("#bike-free").text(bikeFreeSpots);
                const bikePercentage = (bikes / BIKE_CAPACITY) * 100;
                $("#bike-percentage").text(Math.round(bikePercentage) + "%");
                $("#bike-progress-bar").css("width", bikePercentage + "%");

                // Update overall capacity details
                $("#car-capacity").text(`${cars}/${CAR_CAPACITY}`);
                $("#bike-capacity").text(`${bikes}/${BIKE_CAPACITY}`);
                $("#total-capacity").text(`${filledSpaces}/${TOTAL_CAPACITY}`);

                // Update overall progress bar
                const totalPercentage = (filledSpaces / TOTAL_CAPACITY) * 100;
                $("#capacity-percentage").text(Math.round(totalPercentage) + "%");
                $("#capacity-bar").css("width", totalPercentage + "%");

                // Show/hide full lot alert with specific messages
                const isCarLotFull = cars >= CAR_CAPACITY;
                const isBikeLotFull = bikes >= BIKE_CAPACITY;
                
                if (isCarLotFull && isBikeLotFull) {
                    $("#lot-full-alert").html('<i class="fas fa-exclamation-circle"></i> Both car and bike sections are full!').show();
                } else if (isCarLotFull) {
                    $("#lot-full-alert").html('<i class="fas fa-exclamation-circle"></i> Four wheeler parking section is full!').show();
                } else if (isBikeLotFull) {
                    $("#lot-full-alert").html('<i class="fas fa-exclamation-circle"></i> Two wheeler parking section is full!').show();
                } else {
                    $("#lot-full-alert").hide();
                }
            }

            /**
             * Fetches data from the server and updates the UI, unless a manual update is active.
             */
            function fetchAndUpdateDashboard() {
                if (isManualUpdateActive) {
                    console.log("Auto-update paused due to manual edit.");
                    return;
                }
                $.ajax({
                    url: "/get_counts",
                    method: "GET",
                    success: function (data) {
                        updateUI(data);
                    },
                    error: function () {
                        console.log("Error fetching counts");
                    },
                });
            }

            const modal = $('#edit-modal');
            let currentType;

            $('input[name="update-type"]').on('change', function() {
                if (this.value === 'total') {
                    $('#total-input').prop('disabled', false);
                    $('#additive-input').prop('disabled', true);
                } else {
                    $('#total-input').prop('disabled', true);
                    $('#additive-input').prop('disabled', false);
                }
            });

            $('.edit-icon').on('click', function() {
                currentType = $(this).data('type');
                const capacity = (currentType === 'car') ? CAR_CAPACITY : BIKE_CAPACITY;
                const currentFilled = parseInt($(`#${currentType}-filled`).text());
                
                $('#modal-title').text(`Update ${currentType === 'car' ? 'Four Wheeler' : 'Two Wheeler'} Count`);
                $('#total-input').val(currentFilled).attr('max', capacity);
                $('input[value="total"]').prop('checked', true).trigger('change');
                modal.css('display', 'flex');
            });

            $('#cancel-btn').on('click', () => modal.hide());

            $('#update-btn').on('click', function() {
                const updateType = $('input[name="update-type"]:checked').val();
                const capacity = (currentType === 'car') ? CAR_CAPACITY : BIKE_CAPACITY;
                const currentFilled = parseInt($(`#${currentType}-filled`).text());
                let newFilled;

                if (updateType === 'total') {
                    newFilled = parseInt($('#total-input').val());
                } else {
                    const additiveValue = parseInt($('#additive-input').val());
                    newFilled = currentFilled + additiveValue;
                }

                if (isNaN(newFilled) || newFilled < 0 || newFilled > capacity) {
                    alert(`Invalid input. Please enter a number between 0 and ${capacity}.`);
                    return;
                }

                modal.hide();
                isManualUpdateActive = true;
                clearTimeout(manualUpdateTimer);
                $('#system-status').html('<i class="fas fa-pause-circle"></i> Manual Override').addClass('manual-override');

                const currentData = {
                    cars: parseInt($('#car-filled').text()),
                    bikes: parseInt($('#bike-filled').text())
                };
                currentData[currentType + 's'] = newFilled;
                
                updateUI(currentData);

                $.ajax({
                    url: "/update_manual_counts",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(currentData),
                });

                manualUpdateTimer = setTimeout(() => {
                    isManualUpdateActive = false;
                    $('#system-status').html('<i class="fas fa-circle"></i> System Active').removeClass('manual-override');
                    fetchAndUpdateDashboard();
                }, 15000);
            });

            setInterval(fetchAndUpdateDashboard, 1000);
            
            fetchAndUpdateDashboard();
        });
    </script>
</body>
</html>
